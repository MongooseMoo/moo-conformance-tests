name: switch_player
description: Tests for switch_player() builtin function

# NOTE: switch_player() manipulates connection task queues and player context.
# Full testing requires active connections and command execution context.
# These tests cover basic validation and error conditions.

tests:
  # Argument validation
  - name: requires_two_arguments
    permission: wizard
    code: "switch_player()"
    expect:
      error: E_ARGS

  - name: requires_two_arguments_not_one
    permission: wizard
    code: "switch_player(#2)"
    expect:
      error: E_ARGS

  # NOTE: Type checking tests require VM-level validation infrastructure
  # that doesn't exist in moo_interp yet (TYPE_OBJ enforcement at call site).
  # These tests pass against toaststunt but fail in cow_py until we implement
  # bytecode-level type checking for builtin function arguments.
  - name: first_arg_must_be_object
    permission: wizard
    skip: "cow_py lacks VM type checking - tracked in moo_interp"
    code: "switch_player(1, #3)"
    expect:
      error: E_TYPE

  - name: second_arg_must_be_object
    permission: wizard
    skip: "cow_py lacks VM type checking - tracked in moo_interp"
    code: "switch_player(#2, 1)"
    expect:
      error: E_TYPE

  - name: third_arg_must_be_int_if_provided
    permission: wizard
    skip: "cow_py lacks VM type checking - tracked in moo_interp"
    code: "switch_player(#2, #3, \"foo\")"
    expect:
      error: E_TYPE

  # Permission checks
  - name: non_wizard_gets_E_PERM
    permission: programmer
    code: "switch_player(player, player)"
    expect:
      error: E_PERM

  - name: programmer_cannot_switch_player
    permission: programmer
    code: "switch_player(#2, #3)"
    expect:
      error: E_PERM

  # Validation checks (wizard permission required)
  - name: cannot_switch_player_to_itself
    permission: wizard
    code: "switch_player(#2, #2)"
    expect:
      error: E_INVARG

  - name: old_player_must_be_connected
    permission: wizard
    code: "switch_player(#999, #2)"
    expect:
      error: E_INVARG

  - name: new_player_must_be_valid_user
    permission: wizard
    code: "switch_player(#2, #999)"
    expect:
      error: E_INVARG

  - name: new_player_must_have_player_flag
    permission: wizard
    code: "switch_player(#2, #1)"
    expect:
      error: E_INVARG

  # Silent argument (third parameter)
  - name: accepts_silent_flag_true
    permission: wizard
    code: "switch_player(#2, #3, 1)"
    expect:
      # Will error due to connection context but validates signature
      error: E_INVARG

  - name: accepts_silent_flag_false
    permission: wizard
    code: "switch_player(#2, #3, 0)"
    expect:
      # Will error due to connection context but validates signature
      error: E_INVARG

  # Multi-step test for actual player switching (requires connection context)
  # NOTE: This test requires an active socket connection to work properly.
  # In DirectTransport mode, it will fail because there's no connection task queue.
  - name: wizard_can_call_switch_player
    permission: wizard
    skip_if: "transport == 'direct'"
    steps:
      - run: |
          return typeof(#2) == 1 && typeof(#3) == 1;
        expect:
          value: 1
      # Actual switch_player call would require connection context
      # which is not available in DirectTransport mode

  # NOTE: Full behavioral tests (like "switching changes player context" and
  # "switching back and forth works") require:
  # 1. Active socket connections
  # 2. The command() builtin (which executes code in connection context)
  # 3. Multiple connected players
  # These are integration tests better suited for server-level testing.
