name: string
description: Basic string operations

tests:
  - name: length_returns_string_length
    code: 'length("foo")'
    expect:
      value: 3

  - name: strsub_substitutes_substring
    code: 'strsub("foobarbaz", "bar", "quxx")'
    expect:
      value: "fooquxxbaz"

  - name: index_finds_substring_position
    code: 'index("foobar", "bar")'
    expect:
      value: 4

  - name: index_returns_zero_when_not_found
    code: 'index("foobar", "baz")'
    expect:
      value: 0

  - name: index_case_sensitive_finds_match
    code: 'index("fooBar", "bar")'
    expect:
      value: 4

  - name: index_case_sensitive_no_match_basic
    code: 'index("fooBar", "baz")'
    expect:
      value: 0

  - name: index_case_insensitive_no_match
    code: 'index("fooBar", "bar", 1)'
    expect:
      value: 0

  - name: rindex_finds_last_occurrence_basic
    code: 'rindex("bazbarbazfoo", "baz")'
    expect:
      value: 7

  - name: rindex_returns_zero_when_not_found
    code: 'rindex("bazbarbazfoo", "quxx")'
    expect:
      value: 0

  - name: rindex_case_sensitive_finds_match
    code: 'rindex("bazbarBazfoo", "baz")'
    expect:
      value: 7

  - name: rindex_case_insensitive_finds_first
    code: 'rindex("bazbarBazfoo", "baz", 1)'
    expect:
      value: 1

  - name: strcmp_less_than
    code: 'strcmp("abc", "abd") < 0'
    expect:
      value: 1

  - name: strcmp_greater_than
    code: 'strcmp("abd", "abc") > 0'
    expect:
      value: 1

  - name: strcmp_equal
    code: 'strcmp("abc", "abc")'
    expect:
      value: 0

  - name: decode_binary_simple_string
    code: 'decode_binary("foo")'
    expect:
      value: ["foo"]

  - name: decode_binary_with_escapes
    code: 'decode_binary("foo~0D~0A")'
    expect:
      value: ["foo", 13, 10]

  - name: decode_binary_multiple_lines
    code: 'decode_binary("foo~0Abar~0A")'
    expect:
      value: ["foo", 10, "bar", 10]

  - name: decode_binary_to_bytes
    code: 'decode_binary("foo~0D~0A", 1)'
    expect:
      value: [102, 111, 111, 13, 10]

  - name: encode_binary_escapes_tilde
    code: 'encode_binary("~foo")'
    expect:
      value: "~7Efoo"

  - name: encode_binary_with_list
    code: 'encode_binary({"foo", 10}, {"bar", 13})'
    expect:
      value: "foo~0Abar~0D"

  - name: encode_binary_with_varargs
    code: 'encode_binary("foo", 10, "bar", 13)'
    expect:
      value: "foo~0Abar~0D"

  # ===========================================================================
  # encode_binary / decode_binary edge cases
  # ===========================================================================

  - name: decode_binary_empty_string
    code: 'decode_binary("")'
    expect:
      value: []

  - name: decode_binary_null_byte
    code: 'decode_binary("~00")'
    expect:
      value: [0]

  - name: decode_binary_null_byte_fully
    code: 'decode_binary("~00", 1)'
    expect:
      value: [0]

  - name: decode_binary_bad_escape
    code: 'decode_binary("~ZZ")'
    expect:
      error: E_INVARG

  - name: encode_binary_no_args
    code: 'encode_binary()'
    expect:
      value: ""

  - name: encode_binary_empty_list
    code: 'encode_binary({})'
    expect:
      value: ""

  - name: encode_binary_out_of_range
    code: 'encode_binary(256)'
    expect:
      error: E_INVARG

  - name: encode_binary_negative
    code: 'encode_binary(-1)'
    expect:
      error: E_INVARG

  - name: encode_binary_object_type
    code: 'encode_binary(#1)'
    expect:
      error: E_INVARG

  - name: encode_binary_roundtrip
    code: 'decode_binary(encode_binary(65, 0, 10), 1)'
    expect:
      value: [65, 0, 10]

  - name: crypt_hashes_string
    skip: "DES crypt not supported on Windows"
    code: 'crypt("foobar", "SA")'
    expect:
      value: "SAEmC5UwrAl2A"

  - name: crypt_bcrypt_hashes_string
    skip: "Windows Toast only supports $2a$, not $2b$"
    code: 'index(crypt("password", "$2b$05$1234567890123456"), "$2b$05$")'
    expect:
      value: 1

  # ===========================================================================
  # strsub edge cases
  # ===========================================================================

  - name: strsub_case_insensitive_default
    description: "Default is case-insensitive (case_matters=0)"
    code: 'strsub("FooBarFoo", "foo", "baz")'
    expect:
      value: "bazBarbaz"

  - name: strsub_case_sensitive
    description: "Case-sensitive mode, no match for different case"
    code: 'strsub("FooBarFoo", "foo", "baz", 1)'
    expect:
      value: "FooBarFoo"

  - name: strsub_case_sensitive_match
    description: "Case-sensitive mode matches only exact case"
    code: 'strsub("FooBarfoo", "foo", "baz", 1)'
    expect:
      value: "FooBarbaz"

  - name: strsub_empty_what_is_invarg
    description: "Empty search string returns E_INVARG"
    code: 'strsub("foobar", "", "x")'
    expect:
      error: E_INVARG

  - name: strsub_empty_source
    code: 'strsub("", "x", "y")'
    expect:
      value: ""

  - name: strsub_with_empty_replacement
    description: "Replacing with empty string removes matches"
    code: 'strsub("foobar", "o", "")'
    expect:
      value: "fbar"

  - name: strsub_multiple_occurrences
    code: 'strsub("abcabcabc", "abc", "x")'
    expect:
      value: "xxx"

  # ===========================================================================
  # strcmp edge cases
  # ===========================================================================

  - name: strcmp_case_differs
    description: "Case-sensitive comparison, result is platform-consistent type"
    code: 'strcmp("abc", "ABC")'
    expect:
      type: int

  - name: strcmp_case_differs_direction
    description: "In ASCII, 'a' (97) > 'A' (65), so strcmp returns positive"
    code: 'strcmp("abc", "ABC") > 0'
    expect:
      value: 1

  - name: strcmp_empty_strings
    code: 'strcmp("", "")'
    expect:
      value: 0

  - name: strcmp_empty_vs_nonempty
    description: "Empty string is less than any non-empty string"
    code: 'strcmp("", "a") < 0'
    expect:
      value: 1

  - name: strcmp_prefix
    description: "Shorter prefix is less than longer string"
    code: 'strcmp("abc", "abcd") < 0'
    expect:
      value: 1

  # ===========================================================================
  # length edge cases
  # ===========================================================================

  - name: length_empty_string
    code: 'length("")'
    expect:
      value: 0

  - name: length_type_error_on_int
    code: 'length(42)'
    expect:
      error: E_TYPE

  - name: length_type_error_on_object
    code: 'length(#0)'
    expect:
      error: E_TYPE
