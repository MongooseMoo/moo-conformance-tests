name: fileio
description: |
  Tests for MOO file I/O builtins - file_open, file_close, file_read/write, file operations.
  Converted from test_fileio.rb. Auto-skipped via requires if file I/O builtins are absent.
  Each test uses a unique temp filename to avoid Windows file-handle contamination.

requires:
  builtins: [file_open, file_close, file_readline, file_readlines, file_writeline, file_read, file_write, file_tell, file_seek, file_eof, file_size, file_mode, file_last_access, file_last_modify, file_last_change, file_stat, file_rename, file_remove, file_mkdir, file_rmdir, file_list, file_type, file_chmod, file_name, file_openmode]

tests:
  # Permission tests - all file operations require wizard
  - name: file_open_requires_wizard
    permission: programmer
    code: 'file_open("", "")'
    expect:
      error: E_PERM

  - name: file_close_requires_wizard
    permission: programmer
    code: "file_close(0)"
    expect:
      error: E_PERM

  - name: file_name_requires_wizard
    permission: programmer
    code: "file_name(0)"
    expect:
      error: E_PERM

  - name: file_openmode_requires_wizard
    permission: programmer
    code: "file_openmode(0)"
    expect:
      error: E_PERM

  - name: file_readline_requires_wizard
    permission: programmer
    code: "file_readline(0)"
    expect:
      error: E_PERM

  - name: file_readlines_requires_wizard
    permission: programmer
    code: "file_readlines(0, 1, 2)"
    expect:
      error: E_PERM

  - name: file_writeline_requires_wizard
    permission: programmer
    code: 'file_writeline(0, "")'
    expect:
      error: E_PERM

  - name: file_read_requires_wizard
    permission: programmer
    code: "file_read(0, 1)"
    expect:
      error: E_PERM

  - name: file_write_requires_wizard
    permission: programmer
    code: 'file_write(0, "")'
    expect:
      error: E_PERM

  - name: file_tell_requires_wizard
    permission: programmer
    code: "file_tell(0)"
    expect:
      error: E_PERM

  - name: file_seek_requires_wizard
    permission: programmer
    code: 'file_seek(0, 1, "")'
    expect:
      error: E_PERM

  - name: file_eof_requires_wizard
    permission: programmer
    code: "file_eof(0)"
    expect:
      error: E_PERM

  - name: file_size_str_requires_wizard
    permission: programmer
    code: 'file_size("")'
    expect:
      error: E_PERM

  - name: file_size_int_requires_wizard
    permission: programmer
    code: "file_size(0)"
    expect:
      error: E_PERM

  - name: file_mode_str_requires_wizard
    permission: programmer
    code: 'file_mode("")'
    expect:
      error: E_PERM

  - name: file_mode_int_requires_wizard
    permission: programmer
    code: "file_mode(0)"
    expect:
      error: E_PERM

  - name: file_last_access_str_requires_wizard
    permission: programmer
    code: 'file_last_access("")'
    expect:
      error: E_PERM

  - name: file_last_access_int_requires_wizard
    permission: programmer
    code: "file_last_access(0)"
    expect:
      error: E_PERM

  - name: file_last_modify_str_requires_wizard
    permission: programmer
    code: 'file_last_modify("")'
    expect:
      error: E_PERM

  - name: file_last_modify_int_requires_wizard
    permission: programmer
    code: "file_last_modify(0)"
    expect:
      error: E_PERM

  - name: file_last_change_str_requires_wizard
    permission: programmer
    code: 'file_last_change("")'
    expect:
      error: E_PERM

  - name: file_last_change_int_requires_wizard
    permission: programmer
    code: "file_last_change(0)"
    expect:
      error: E_PERM

  - name: file_stat_str_requires_wizard
    permission: programmer
    code: 'file_stat("")'
    expect:
      error: E_PERM

  - name: file_stat_int_requires_wizard
    permission: programmer
    code: "file_stat(0)"
    expect:
      error: E_PERM

  - name: file_rename_requires_wizard
    permission: programmer
    code: 'file_rename("", "")'
    expect:
      error: E_PERM

  - name: file_remove_requires_wizard
    permission: programmer
    code: 'file_remove("")'
    expect:
      error: E_PERM

  - name: file_mkdir_requires_wizard
    permission: programmer
    code: 'file_mkdir("")'
    expect:
      error: E_PERM

  - name: file_rmdir_requires_wizard
    permission: programmer
    code: 'file_rmdir("")'
    expect:
      error: E_PERM

  - name: file_list_requires_wizard
    permission: programmer
    code: 'file_list("")'
    expect:
      error: E_PERM

  - name: file_list_detailed_requires_wizard
    permission: programmer
    code: 'file_list("", 1)'
    expect:
      error: E_PERM

  - name: file_type_requires_wizard
    permission: programmer
    code: 'file_type("")'
    expect:
      error: E_PERM

  - name: file_chmod_requires_wizard
    permission: programmer
    code: 'file_chmod("", "")'
    expect:
      error: E_PERM

  # file_version - may not exist on all builds
  - name: file_version_public
    permission: programmer
    skip_if: "missing builtin.file_version"
    statement: |
      result = file_version();
      return typeof(result) == STR;
    expect:
      value: 1

  # Text file operations
  - name: text_file_write_read
    permission: wizard
    statement: |
      fh = file_open("__test_txtwr.tmp", "w-tn");
      file_writeline(fh, "one two three four five");
      file_close(fh);
      fh = file_open("__test_txtwr.tmp", "r-tn");
      line = file_readline(fh);
      file_close(fh);
      sz = file_size("__test_txtwr.tmp");
      file_remove("__test_txtwr.tmp");
      return {line, sz};
    expect:
      value: ["one two three four five", 24]

  # Binary file operations
  - name: binary_file_write_read
    permission: wizard
    statement: |
      fh = file_open("__test_binwr.tmp", "w-bn");
      file_write(fh, "~A7~CE~F7~8E~0C~D2~16~C9~F6~F2~01~19");
      file_close(fh);
      fh = file_open("__test_binwr.tmp", "r-bn");
      data = file_read(fh, 12);
      file_close(fh);
      sz = file_size("__test_binwr.tmp");
      file_remove("__test_binwr.tmp");
      return {data, sz};
    expect:
      value: ['~A7~CE~F7~8E~0C~D2~16~C9~F6~F2~01~19', 12]

  # Reading binary data in text mode filters non-text bytes
  - name: binary_in_text_mode_with_newline
    permission: wizard
    statement: |
      fh = file_open("__test_b2t_nl.tmp", "w-bn");
      file_write(fh, "abc~A7~CE~F7~8E~00~D2~16~C9~F6~F2~01~19123~0A");
      file_close(fh);
      fh = file_open("__test_b2t_nl.tmp", "r-tn");
      line = file_readline(fh);
      file_close(fh);
      file_remove("__test_b2t_nl.tmp");
      return line;
    expect:
      value: "abc123"

  - name: binary_in_text_mode_without_newline
    permission: wizard
    statement: |
      fh = file_open("__test_b2t_nonl.tmp", "w-bn");
      file_write(fh, "abc~A7~CE~F7~8E~00~D2~16~C9~F6~F2~01~19123");
      file_close(fh);
      fh = file_open("__test_b2t_nonl.tmp", "r-tn");
      line = file_readline(fh);
      file_close(fh);
      file_remove("__test_b2t_nonl.tmp");
      return line;
    expect:
      value: "abc123"

  # file_readlines tests - error cases use try/except for cleanup
  - name: readlines_invalid_start_line
    permission: wizard
    statement: |
      fh = file_open("__test_rl_inv1.tmp", "w-tn");
      file_writeline(fh, "one");
      file_writeline(fh, "two");
      file_writeline(fh, "three");
      file_close(fh);
      fh = file_open("__test_rl_inv1.tmp", "r-tn");
      try result = file_readlines(fh, 0, 4); except e (ANY) file_close(fh); file_remove("__test_rl_inv1.tmp"); raise(e[1]); endtry
      file_close(fh);
      file_remove("__test_rl_inv1.tmp");
      return result;
    expect:
      error: E_INVARG

  - name: readlines_invalid_end_before_start
    permission: wizard
    statement: |
      fh = file_open("__test_rl_inv2.tmp", "w-tn");
      file_writeline(fh, "one");
      file_writeline(fh, "two");
      file_writeline(fh, "three");
      file_close(fh);
      fh = file_open("__test_rl_inv2.tmp", "r-tn");
      try result = file_readlines(fh, 5, 1); except e (ANY) file_close(fh); file_remove("__test_rl_inv2.tmp"); raise(e[1]); endtry
      file_close(fh);
      file_remove("__test_rl_inv2.tmp");
      return result;
    expect:
      error: E_INVARG

  - name: readlines_multiple_lines
    permission: wizard
    statement: |
      fh = file_open("__test_rl_multi.tmp", "w-tn");
      file_writeline(fh, "one");
      file_writeline(fh, "two");
      file_writeline(fh, "three");
      file_writeline(fh, "four");
      file_writeline(fh, "five");
      file_close(fh);
      fh = file_open("__test_rl_multi.tmp", "r-tn");
      lines = file_readlines(fh, 1, 500);
      file_close(fh);
      file_remove("__test_rl_multi.tmp");
      return lines;
    expect:
      value: ["one", "two", "three", "four", "five"]

  - name: readlines_blank_lines
    permission: wizard
    statement: |
      fh = file_open("__test_rl_blank.tmp", "w-tn");
      file_writeline(fh, "");
      file_writeline(fh, "");
      file_writeline(fh, "");
      file_writeline(fh, "");
      file_writeline(fh, "");
      file_close(fh);
      fh = file_open("__test_rl_blank.tmp", "r-tn");
      lines = file_readlines(fh, 1, 500);
      file_close(fh);
      file_remove("__test_rl_blank.tmp");
      return lines;
    expect:
      value: ["", "", "", "", ""]

  - name: readlines_on_write_output
    permission: wizard
    statement: |
      fh = file_open("__test_rl_write.tmp", "w-tn");
      file_write(fh, "one");
      file_write(fh, "two");
      file_write(fh, "three");
      file_write(fh, "four");
      file_write(fh, "five");
      file_close(fh);
      fh = file_open("__test_rl_write.tmp", "r-tn");
      lines = file_readlines(fh, 1, 5);
      file_close(fh);
      file_remove("__test_rl_write.tmp");
      return lines;
    expect:
      value: ["onetwothreefourfive"]

  # Text in binary mode preserves newlines
  - name: text_in_binary_mode
    permission: wizard
    statement: |
      fh = file_open("__test_t2b.tmp", "w-tn");
      file_writeline(fh, "one two three four five");
      file_close(fh);
      fh = file_open("__test_t2b.tmp", "r-bn");
      line = file_read(fh, 24);
      file_close(fh);
      file_remove("__test_t2b.tmp");
      return line;
    expect:
      value: "one two three four five~0A"

  # Reading empty files produces E_FILE, caught so we can also check file_eof
  - name: empty_file_text_mode
    permission: wizard
    statement: |
      fh = file_open("__test_emptyrd_t.tmp", "w-tn");
      file_close(fh);
      fh = file_open("__test_emptyrd_t.tmp", "r-tn");
      try result = file_readline(fh); except e (ANY) result = e[1]; endtry
      eof = file_eof(fh);
      file_close(fh);
      file_remove("__test_emptyrd_t.tmp");
      return {result, eof};
    expect:
      value: ["E_FILE", 1]

  - name: empty_file_binary_mode
    permission: wizard
    statement: |
      fh = file_open("__test_emptyrd_b.tmp", "w-bn");
      file_close(fh);
      fh = file_open("__test_emptyrd_b.tmp", "r-bn");
      try result = file_read(fh, 100); except e (ANY) result = e[1]; endtry
      eof = file_eof(fh);
      file_close(fh);
      file_remove("__test_emptyrd_b.tmp");
      return {result, eof};
    expect:
      value: ["E_FILE", 1]

  # Writing invalid binary strings - Toast rejects ~ZZ as invalid hex
  - name: invalid_binary_string_writeline
    permission: wizard
    statement: |
      fh = file_open("__test_invbin1.tmp", "w-bn");
      try file_writeline(fh, "abc~ZZ"); except e (ANY) file_close(fh); file_remove("__test_invbin1.tmp"); raise(e[1]); endtry
      file_close(fh);
      file_remove("__test_invbin1.tmp");
      return 1;
    expect:
      error: E_INVARG

  - name: invalid_binary_string_write
    permission: wizard
    statement: |
      fh = file_open("__test_invbin2.tmp", "w-bn");
      try file_write(fh, "abc~ZZ"); except e (ANY) file_close(fh); file_remove("__test_invbin2.tmp"); raise(e[1]); endtry
      file_close(fh);
      file_remove("__test_invbin2.tmp");
      return 1;
    expect:
      error: E_INVARG

  # Large file tests - use loop to build long strings (MOO has no string * operator)
  - name: long_file_text_mode
    permission: wizard
    statement: |
      fh = file_open("__test_long_t.tmp", "w-tn");
      s = "";
      for i in [1..100]
        s = s + "1234567890";
      endfor
      for i in [1..10]
        file_writeline(fh, s);
      endfor
      file_close(fh);
      fh = file_open("__test_long_t.tmp", "r-tn");
      lines = file_readlines(fh, 1, 100);
      file_close(fh);
      file_remove("__test_long_t.tmp");
      return {length(lines), length(lines[1])};
    expect:
      value: [10, 1000]

  - name: long_file_binary_mode
    permission: wizard
    statement: |
      fh = file_open("__test_long_b.tmp", "w-bn");
      s = "";
      for i in [1..100]
        s = s + "1234567890";
      endfor
      for i in [1..10]
        file_write(fh, s);
      endfor
      file_close(fh);
      fh = file_open("__test_long_b.tmp", "r-bn");
      data = file_read(fh, 10000);
      file_close(fh);
      file_remove("__test_long_b.tmp");
      return length(data);
    expect:
      value: 10000
